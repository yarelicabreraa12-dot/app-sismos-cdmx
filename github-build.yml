name: Build App Sismos CDMX Android APK
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          zlib1g-dev \
          libncurses5-dev \
          libgdbm-dev \
          libnss3-dev \
          libssl-dev \
          libreadline-dev \
          libffi-dev \
          libsqlite3-dev \
          wget \
          libjpeg-dev \
          libopenjp2-7-dev \
          libfreetype6-dev \
          libc6-dev \
          locales \
          ccache \
          ninja-build \
          c4core-tools \
          freeglut3-dev \
          libglew-dev \
          libgles2-mesa-dev \
          libglib2.0-dev \
          libgmp-dev \
          libmpfr-dev \
          libgomp1 \
          libgtk-3-dev \
          libharfbuzz-dev \
          libhdf5-dev \
          libjpeg-dev \
          libjpeg9-dev \
          libjpeg-turbo8-dev \
          liblz-dev \
          libmagickwand-dev \
          libncurses-dev \
          libpng-dev \
          libpq-dev \
          libraw-dev \
          librsvg2-dev \
          libssl-dev \
          libtiff5-dev \
          libwebp-dev \
          libxml2-dev \
          libxslt1-dev \
          llvm \
          make \
          opengl-headers \
          python3-opengl \
          scons \
          tcl8.6-dev \
          tk8.6-dev-dev \
          wget \
          xz-utils \
          openjdk-11-jdk \
          git
    
    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          ~/.local/share/virtualenvs
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flet>=0.21.0
        pip install buildozer>=1.5.0
        pip install requests
    
    - name: Verify Buildozer installation
      run: |
        python -m buildozer --version
        python -c "import buildozer; print('Buildozer imported successfully')"
    
    - name: Initialize buildozer project
      run: |
        python -m buildozer init
        echo "Buildozer project initialized"
        ls -la
    
    - name: Copy application file
      run: |
        if [ -f "app_sismos_cdmx_FINAL.py" ]; then
          cp app_sismos_cdmx_FINAL.py main.py
          echo "App file copied successfully"
        else
          echo "Error: app_sismos_cdmx_FINAL.py not found!"
          ls -la
          exit 1
        fi
    
    - name: Update buildozer.spec
      run: |
        python -m buildozer android debug clean || true
        echo "Clean completed or not needed"
    
    - name: Build APK with retry logic
      run: |
        echo "Starting APK build process..."
        echo "This may take 30-60 minutes on first run..."
        
        # Try building with increased timeout and retry logic
        for attempt in 1 2 3; do
          echo "Attempt $attempt of 3..."
          
          if python -m buildozer android debug --verbose; then
            echo "Build successful on attempt $attempt"
            break
          else
            echo "Build failed on attempt $attempt"
            if [ $attempt -eq 3 ]; then
              echo "All build attempts failed"
              exit 1
            else
              echo "Waiting 30 seconds before retry..."
              sleep 30
            fi
          fi
        done
    
    - name: Check if APK was created
      run: |
        echo "Checking for APK files..."
        if [ -f "bin/*.apk" ]; then
          echo "APK files found:"
          ls -la bin/
        else
          echo "No APK files found!"
          echo "Contents of bin directory:"
          if [ -d "bin" ]; then
            ls -la bin/
          else
            echo "bin directory does not exist"
          fi
          echo "Contents of app_sismos_android directory:"
          if [ -d "app_sismos_android" ]; then
            find app_sismos_android -name "*.apk" 2>/dev/null || echo "No APK files found in app_sismos_android"
            ls -la app_sismos_android/
          else
            echo "app_sismos_android directory does not exist"
          fi
          exit 1
        fi
    
    - name: Upload APK artifacts
      uses: actions/upload-artifact@v3
      with:
        name: app-sismos-cdmx-apk
        path: |
          bin/*.apk
        retention-days: 30
    
    - name: Upload APK as Release (if on main branch)
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        files: bin/*.apk
        tag_name: v1.0.0-${{ github.sha }}
        name: App Sismos CDMX APK v1.0.0
        body: |
          ğŸš¨ App Sismos CDMX - Sistema de PrevenciÃ³n SÃ­smica
          
          ğŸ“± APK construido automÃ¡ticamente por GitHub Actions
          
          âœ… CaracterÃ­sticas incluidas:
          - ğŸ‘©â€ğŸ’» CrÃ©ditos de las 4 creadoras
          - ğŸ“± EnvÃ­o automÃ¡tico por WhatsApp
          - ğŸ“ GeolocalizaciÃ³n funcional
          - ğŸ’¾ Sistema de contactos
          - ğŸ§ª Simulador de emergencia
          - ğŸ”Š Sonido de alerta
          - ğŸ’ Kit de emergencia
          - ğŸ“ Registro de sismos
          
          ğŸ“‹ Instrucciones:
          1. Descargar este APK
          2. Transferir a dispositivo Android
          3. Habilitar "Fuentes desconocidas"
          4. Instalar APK
          5. Â¡Listo para usar!
          
          ğŸ¢ Creado por:
          - Vazquez Torralva Abigail Valeria
          - Cabrera Cruz Yareli Rubi
          - Ramirez Bautista Jimena Montserrat
          - Ortiz Garcia Italia Nicole
          
          â„¹ï¸ Construido el: ${{ github.event.head_commit.timestamp }}
          ğŸ”— Commit: ${{ github.sha }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Log build summary
      run: |
        echo "=== BUILD SUMMARY ==="
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Workflow: ${{ github.workflow }}"
        echo "Run ID: ${{ github.run_id }}"
        echo "Actor: ${{ github.actor }}"
        echo "Timestamp: $(date)"
        echo "Build completed successfully!"
        echo "APK artifacts uploaded!"
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "Release created on GitHub!"
        fi
    
    - name: Cleanup workspace
      run: |
        echo "Cleaning up workspace..."
        du -sh . || true
        echo "Workspace size after build:"
        du -sh .
        echo "Build artifacts preserved for download"